<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI News Aggregator</title>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #2d3748; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useReducer } = React;

        // --- State Management ---
        const initialState = {
            feeds: [],
            folders: [],
            articles: [],
            selectedFeed: null,
            selectedArticle: null,
            isSettingsVisible: false,
            isLoadingArticles: false,
            expandedFolders: new Set(),
            draggedItem: null,
            dragOverItem: null,
        };

        function reducer(state, action) {
            switch (action.type) {
                case 'SET_FEEDS':
                    return { ...state, feeds: action.payload };
                case 'SET_FOLDERS':
                    return { ...state, folders: action.payload };
                case 'ADD_FEED':
                    return { ...state, feeds: [...state.feeds, action.payload].sort((a, b) => a.name.localeCompare(b.name)) };
                case 'ADD_FOLDER':
                    return { ...state, folders: [...state.folders, action.payload].sort((a, b) => a.name.localeCompare(b.name)) };
                case 'DELETE_FEED':
                    const newFeeds = state.feeds.filter(f => f.id !== action.payload);
                    const newSelectedFeed = state.selectedFeed?.id === action.payload ? null : state.selectedFeed;
                    return { ...state, feeds: newFeeds, selectedFeed: newSelectedFeed, articles: newSelectedFeed ? state.articles : [], selectedArticle: newSelectedFeed ? state.selectedArticle : null };
                case 'DELETE_FOLDER':
                    return { ...state, folders: state.folders.filter(f => f.id !== action.payload) };
                case 'UPDATE_FEED_DISPLAY_NAME':
                    return {
                        ...state,
                        feeds: state.feeds.map(f => f.id === action.payload.feedId ? { ...f, name: action.payload.displayName } : f),
                        selectedFeed: state.selectedFeed?.id === action.payload.feedId ? { ...state.selectedFeed, name: action.payload.displayName } : state.selectedFeed,
                    };
                case 'MOVE_FEED_TO_FOLDER':
                    return {
                        ...state,
                        feeds: state.feeds.map(f => f.id === action.payload.feedId ? { ...f, folderId: action.payload.folderId } : f),
                    };
                case 'TOGGLE_FOLDER':
                    const newExpandedFolders = new Set(state.expandedFolders);
                    if (newExpandedFolders.has(action.payload)) {
                        newExpandedFolders.delete(action.payload);
                    } else {
                        newExpandedFolders.add(action.payload);
                    }
                    return { ...state, expandedFolders: newExpandedFolders };
                case 'SET_DRAGGED_ITEM':
                    return { ...state, draggedItem: action.payload };
                case 'SET_DRAG_OVER_ITEM':
                    return { ...state, dragOverItem: action.payload };
                case 'SELECT_FEED':
                    if (state.selectedFeed?.id === action.payload.id) return state;
                    return { ...state, selectedFeed: action.payload, selectedArticle: null, articles: [], isLoadingArticles: true };
                case 'SET_ARTICLES':
                    return { ...state, articles: action.payload, isLoadingArticles: false };
                case 'SELECT_ARTICLE':
                    return { ...state, selectedArticle: action.payload, articles: state.articles.map(a => a.id === action.payload.id ? { ...a, isRead: 1 } : a) };
                case 'UPDATE_ARTICLE_STATUS':
                    const { articleId, status, summary } = action.payload;
                    return {
                        ...state,
                        articles: state.articles.map(a => 
                            a.id === articleId 
                            ? { ...a, status, summary: summary !== null ? summary : a.summary } 
                            : a
                        ),
                        selectedArticle: state.selectedArticle?.id === articleId 
                            ? { ...state.selectedArticle, status, summary: summary !== null ? summary : state.selectedArticle.summary }
                            : state.selectedArticle
                    };
                case 'SHOW_SETTINGS':
                    return { ...state, isSettingsVisible: true };
                case 'HIDE_SETTINGS':
                    return { ...state, isSettingsVisible: false };
                default:
                    return state;
            }
        }

        // --- Components ---

        function FeedsPanel({ feeds, folders, selectedFeed, expandedFolders, draggedItem, dragOverItem, onSelectFeed, onShowSettings, onToggleFolder, onDragStart, onDragOver, onDragEnd, onDrop }) {
            // Organize feeds by folder
            const feedsByFolder = feeds.reduce((acc, feed) => {
                const folderId = feed.folderId || 'uncategorized';
                if (!acc[folderId]) acc[folderId] = [];
                acc[folderId].push(feed);
                return acc;
            }, {});

            const renderFeed = (feed, folderContext = null) => {
                const isDragging = draggedItem?.type === 'feed' && draggedItem?.id === feed.id;
                const isDragOver = dragOverItem?.type === 'feed' && dragOverItem?.id === feed.id;
                
                return (
                    <li key={feed.id}
                        draggable
                        className={`p-2 rounded-md cursor-pointer mb-1 ml-4 transition-all duration-200 ${
                            selectedFeed?.id === feed.id ? 'bg-blue-600' : 'hover:bg-gray-700'
                        } ${isDragging ? 'opacity-50 scale-95' : ''} ${
                            isDragOver ? 'border-2 border-blue-400 border-dashed' : ''
                        }`}
                        onClick={() => onSelectFeed(feed)}
                        onDragStart={(e) => onDragStart(e, { type: 'feed', id: feed.id, data: feed })}
                        onDragOver={(e) => onDragOver(e, { type: 'feed', id: feed.id, folderContext })}
                        onDragEnd={onDragEnd}
                        onDrop={(e) => onDrop(e, { type: 'feed', id: feed.id, folderContext })}
                    >
                        <i className="fas fa-grip-vertical text-xs mr-2 text-gray-500"></i>
                        <i className="fas fa-rss text-xs mr-2 text-gray-400"></i>
                        {feed.name}
                    </li>
                );
            };

            const renderFolder = (folder) => {
                const isExpanded = expandedFolders.has(folder.id);
                const folderFeeds = feedsByFolder[folder.id] || [];
                const isDragging = draggedItem?.type === 'folder' && draggedItem?.id === folder.id;
                const isDragOver = dragOverItem?.type === 'folder' && dragOverItem?.id === folder.id;
                
                return (
                    <div key={folder.id} className="mb-2">
                        <div 
                            draggable
                            className={`flex items-center p-2 rounded-md cursor-pointer hover:bg-gray-700 transition-all duration-200 ${
                                isDragging ? 'opacity-50 scale-95' : ''
                            } ${isDragOver ? 'border-2 border-blue-400 border-dashed' : ''}`}
                            onClick={() => onToggleFolder(folder.id)}
                            onDragStart={(e) => onDragStart(e, { type: 'folder', id: folder.id, data: folder })}
                            onDragOver={(e) => onDragOver(e, { type: 'folder', id: folder.id })}
                            onDragEnd={onDragEnd}
                            onDrop={(e) => onDrop(e, { type: 'folder', id: folder.id })}
                        >
                            <i className="fas fa-grip-vertical text-xs mr-2 text-gray-500"></i>
                            <i className={`fas ${isExpanded ? 'fa-chevron-down' : 'fa-chevron-right'} text-xs mr-2 text-gray-400`}></i>
                            <i className="fas fa-folder text-yellow-500 mr-2"></i>
                            <span>{folder.name}</span>
                            <span className="ml-auto text-xs text-gray-500">({folderFeeds.length})</span>
                        </div>
                        {isExpanded && (
                            <ul
                                onDragOver={(e) => onDragOver(e, { type: 'folder-content', id: folder.id })}
                                onDrop={(e) => onDrop(e, { type: 'folder-content', id: folder.id })}
                                className="min-h-4"
                            >
                                {folderFeeds.map(feed => renderFeed(feed, folder.id))}
                                {folderFeeds.length === 0 && dragOverItem?.type === 'folder-content' && dragOverItem?.id === folder.id && (
                                    <li className="p-2 ml-4 text-gray-500 border-2 border-blue-400 border-dashed rounded-md">
                                        Drop feed here
                                    </li>
                                )}
                            </ul>
                        )}
                    </div>
                );
            };

            return (
                <div className="bg-gray-800 h-full flex flex-col p-4">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold">Feeds</h2>
                        <button onClick={onShowSettings} className="text-gray-400 hover:text-white transition-colors">
                            <i className="fas fa-cog"></i>
                        </button>
                    </div>
                    <div className="flex-grow overflow-y-auto">
                        {folders.length > 0 || feeds.length > 0 ? (
                            <div>
                                {folders.map(renderFolder)}
                                {feedsByFolder.uncategorized && feedsByFolder.uncategorized.length > 0 && (
                                    <div className="mt-4 pt-4 border-t border-gray-700">
                                        <div className="text-sm text-gray-400 mb-2 px-2">Uncategorized</div>
                                        <ul
                                            onDragOver={(e) => onDragOver(e, { type: 'uncategorized' })}
                                            onDrop={(e) => onDrop(e, { type: 'uncategorized' })}
                                            className="min-h-4"
                                        >
                                            {feedsByFolder.uncategorized.map(feed => renderFeed(feed, null))}
                                        </ul>
                                    </div>
                                )}
                                {(!feedsByFolder.uncategorized || feedsByFolder.uncategorized.length === 0) && dragOverItem?.type === 'uncategorized' && (
                                    <div className="mt-4 pt-4 border-t border-gray-700">
                                        <div className="text-sm text-gray-400 mb-2 px-2">Uncategorized</div>
                                        <ul className="min-h-4">
                                            <li className="p-2 ml-4 text-gray-500 border-2 border-blue-400 border-dashed rounded-md">
                                                Drop feed here to remove from folder
                                            </li>
                                        </ul>
                                    </div>
                                )}
                            </div>
                        ) : (
                            <div className="text-center text-gray-500 mt-10">Click the <i className="fas fa-cog mx-1"></i> to add a feed.</div>
                        )}
                    </div>
                </div>
            );
        }

        function ArticleStatusIcon({ status }) {
            switch (status) {
                case 'new':
                    return <i className="fas fa-magic-wand-sparkles text-xs text-blue-400" title="Ready to summarize"></i>;
                case 'summarizing':
                    return <i className="fas fa-spinner fa-spin text-xs text-gray-400" title="Summarizing..."></i>;
                case 'failed':
                    return <i className="fas fa-exclamation-triangle text-xs text-red-400" title="Summarization failed"></i>;
                default:
                    return null;
            }
        }

        function ArticlesPanel({ articles, selectedArticle, onSelectArticle, isLoading }) {
            return (
                <div className="bg-gray-800/50 h-full flex flex-col p-4 border-l border-r border-gray-700">
                    <h2 className="text-xl font-bold mb-4">Articles</h2>
                    {isLoading ? (
                        <div className="flex items-center justify-center h-full">
                             <i className="fas fa-spinner fa-spin text-3xl text-gray-400"></i>
                        </div>
                    ) : (
                        <ul className="flex-grow overflow-y-auto">
                            {articles.length > 0 ? articles.map(article => (
                                <li key={article.id}
                                    className={`block p-3 rounded-md cursor-pointer mb-2 border-l-4 ${selectedArticle?.id === article.id ? 'bg-gray-700 border-blue-500' : 'border-transparent hover:bg-gray-700/50'}`}
                                    onClick={() => onSelectArticle(article)}
                                >
                                    <div className="flex justify-between items-start">
                                        <span className={`font-medium ${article.isRead ? 'text-gray-500' : 'text-gray-200'}`}>{article.title}</span>
                                        <div className="flex-shrink-0 ml-2">
                                            <ArticleStatusIcon status={article.status} />
                                        </div>
                                    </div>
                                    <span className="text-xs text-gray-400 mt-1">
                                        {new Date(article.pubDate).toLocaleString()}
                                    </span>
                                </li>
                            )) : (
                                <div className="text-center text-gray-500 mt-10">Select a feed to see articles.</div>
                            )}
                        </ul>
                    )}
                </div>
            );
        }

        function ContentPanel({ article, onRetrySummarization }) {
            if (!article) {
                return (
                    <div className="h-full flex items-center justify-center p-6">
                         <div className="text-center text-gray-500">
                            <i className="fas fa-arrow-left text-3xl mb-4"></i>
                            <p>Select an article to view.</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="h-full flex flex-col p-6 overflow-y-auto">
                    <h1 className="text-3xl font-bold mb-4">{article.title}</h1>
                    <div className="bg-gray-800 p-4 rounded-lg mb-4">
                        <h3 className="text-lg font-semibold mb-2 text-blue-400">AI Summary</h3>
                        
                        {article.status === 'summarizing' && (
                            <div className="text-center p-4">
                                <i className="fas fa-spinner fa-spin mr-2"></i> Generating summary...
                            </div>
                        )}

                        {article.status === 'failed' && (
                            <div className="text-center p-4 bg-red-900/50 rounded-md">
                                <p className="text-red-400 mb-3">Summarization failed.</p>
                                <button 
                                    onClick={() => onRetrySummarization(article.id)}
                                    className="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-1 px-3 rounded-md transition-colors text-sm"
                                >
                                    <i className="fas fa-sync-alt mr-2"></i> Retry
                                </button>
                            </div>
                        )}

                        {article.status === 'summarized' && (
                             <div 
                                className="prose prose-invert max-w-none text-gray-300 leading-relaxed"
                                dangerouslySetInnerHTML={{ __html: marked.parse(article.summary) }}
                             />
                        )}

                        {article.status === 'new' && (
                            <div className="text-gray-400">This article hasn't been summarized yet.</div>
                        )}
                    </div>
                    <div className="flex-grow"></div>
                    <div className="flex space-x-4 mt-4">
                        <a href={article.link} target="_blank" rel="noopener noreferrer" className="flex-1 text-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                            <i className="fas fa-book-open mr-2"></i> Show Full Article
                        </a>
                    </div>
                </div>
            );
        }
        
        function SettingsModal({ feeds, folders, isVisible, onClose, onAddFeed, onDeleteFeed, onUpdateFeedName, onCreateFolder, onDeleteFolder, onMoveFeedToFolder }) {
            if (!isVisible) return null;
            const [url, setUrl] = useState('');
            const [error, setError] = useState('');
            const [isAdding, setIsAdding] = useState(false);
            const [editingFeedId, setEditingFeedId] = useState(null);
            const [editingName, setEditingName] = useState('');
            const [newFolderName, setNewFolderName] = useState('');
            const [isCreatingFolder, setIsCreatingFolder] = useState(false);

            const handleAddSubmit = async (e) => {
                e.preventDefault();
                if (!url) return;
                setIsAdding(true);
                setError('');
                try {
                    await onAddFeed(url);
                    setUrl('');
                } catch (err) {
                    setError(err.message);
                } finally {
                    setIsAdding(false);
                }
            };

            const handleEdit = (feed) => {
                setEditingFeedId(feed.id);
                setEditingName(feed.name);
            };

            const handleCancelEdit = () => {
                setEditingFeedId(null);
                setEditingName('');
            };

            const handleSaveEdit = async (feedId) => {
                await onUpdateFeedName(feedId, editingName);
                handleCancelEdit();
            };

            const handleCreateFolder = async (e) => {
                e.preventDefault();
                if (!newFolderName.trim()) return;
                setIsCreatingFolder(true);
                try {
                    await onCreateFolder(newFolderName.trim());
                    setNewFolderName('');
                } catch (err) {
                    console.error('Failed to create folder:', err);
                } finally {
                    setIsCreatingFolder(false);
                }
            };

            const handleMoveFeedToFolder = async (feedId, folderId) => {
                try {
                    await onMoveFeedToFolder(feedId, folderId);
                } catch (err) {
                    console.error('Failed to move feed:', err);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
                    <div className="bg-gray-800 rounded-lg shadow-2xl p-8 w-full max-w-2xl text-white">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold">Manage Feeds</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-white transition-colors text-2xl">&times;</button>
                        </div>
                        <div className="mb-8">
                            <h3 className="text-xl font-semibold mb-3">Add New RSS Feed</h3>
                            <form className="flex space-x-2" onSubmit={handleAddSubmit}>
                                <input 
                                    type="text" 
                                    value={url}
                                    onChange={(e) => setUrl(e.target.value)}
                                    placeholder="e.g., https://www.theverge.com/rss/index.xml" 
                                    className="flex-grow p-2 rounded-md bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                />
                                <button type="submit" disabled={isAdding} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-colors disabled:bg-gray-500 disabled:cursor-not-allowed">
                                    {isAdding ? <i className="fas fa-spinner fa-spin"></i> : 'Add'}
                                </button>
                            </form>
                            {error && <p className="text-red-400 mt-2">{error}</p>}
                        </div>
                        <div className="mb-8">
                            <h3 className="text-xl font-semibold mb-3">Create Folder</h3>
                            <form className="flex space-x-2" onSubmit={handleCreateFolder}>
                                <input 
                                    type="text" 
                                    value={newFolderName}
                                    onChange={(e) => setNewFolderName(e.target.value)}
                                    placeholder="Folder name" 
                                    className="flex-grow p-2 rounded-md bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                />
                                <button type="submit" disabled={isCreatingFolder} className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition-colors disabled:bg-gray-500 disabled:cursor-not-allowed">
                                    {isCreatingFolder ? <i className="fas fa-spinner fa-spin"></i> : 'Create'}
                                </button>
                            </form>
                        </div>
                        <div className="mb-8">
                            <h3 className="text-xl font-semibold mb-3">Folders</h3>
                            <ul className="space-y-2 max-h-40 overflow-y-auto pr-2">
                                {folders.map(folder => (
                                    <li key={folder.id} className="bg-gray-700 p-3 rounded-md flex justify-between items-center">
                                        <div className="flex items-center">
                                            <i className="fas fa-folder text-yellow-500 mr-2"></i>
                                            <span className="truncate">{folder.name}</span>
                                        </div>
                                        <button onClick={() => onDeleteFolder(folder.id)} className="text-red-500 hover:text-red-400">
                                            <i className="fas fa-trash-alt"></i>
                                        </button>
                                    </li>
                                ))}
                                {folders.length === 0 && (
                                    <div className="text-center text-gray-500 py-4">No folders created yet.</div>
                                )}
                            </ul>
                        </div>
                        <div>
                            <h3 className="text-xl font-semibold mb-3">Current Feeds</h3>
                            <ul className="space-y-2 max-h-60 overflow-y-auto pr-2">
                                {feeds.map(feed => (
                                    <li key={feed.id} className="bg-gray-700 p-3 rounded-md">
                                        <div className="flex justify-between items-center mb-2">
                                            {editingFeedId === feed.id ? (
                                                <input 
                                                    type="text"
                                                    value={editingName}
                                                    onChange={(e) => setEditingName(e.target.value)}
                                                    className="flex-grow p-1 rounded-md bg-gray-600 border border-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                />
                                            ) : (
                                                <span className="truncate">{feed.name}</span>
                                            )}
                                            <div className="flex items-center space-x-2">
                                                {editingFeedId === feed.id ? (
                                                    <>
                                                        <button onClick={() => handleSaveEdit(feed.id)} className="text-green-500 hover:text-green-400"><i className="fas fa-check"></i></button>
                                                        <button onClick={handleCancelEdit} className="text-gray-500 hover:text-gray-400"><i className="fas fa-times"></i></button>
                                                    </>
                                                ) : (
                                                    <button onClick={() => handleEdit(feed)} className="text-gray-400 hover:text-white"><i className="fas fa-pencil-alt"></i></button>
                                                )}
                                                <button onClick={() => onDeleteFeed(feed.id)} className="text-red-500 hover:text-red-400"><i className="fas fa-trash-alt"></i></button>
                                            </div>
                                        </div>
                                        <div className="flex items-center space-x-2">
                                            <span className="text-sm text-gray-400">Folder:</span>
                                            <select 
                                                value={feed.folderId || ''}
                                                onChange={(e) => handleMoveFeedToFolder(feed.id, e.target.value || null)}
                                                className="bg-gray-600 border border-gray-500 rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            >
                                                <option value="">No folder</option>
                                                {folders.map(folder => (
                                                    <option key={folder.id} value={folder.id}>{folder.name}</option>
                                                ))}
                                            </select>
                                        </div>
                                    </li>
                                ))}
                            </ul>
                        </div>
                    </div>
                </div>
            );
        }

        // Main App Component
        function App() {
            const [state, dispatch] = useReducer(reducer, initialState);
            const { feeds, folders, articles, selectedFeed, selectedArticle, isSettingsVisible, isLoadingArticles, expandedFolders, draggedItem, dragOverItem } = state;

            // --- API Abstractions ---
            const handleSelectFeed = useCallback(async (feed) => {
                dispatch({ type: 'SELECT_FEED', payload: feed });
                try {
                    const fetchedArticles = await window.api.getArticles(feed.id);
                    dispatch({ type: 'SET_ARTICLES', payload: fetchedArticles });
                } catch (error) {
                    console.error("Failed to fetch articles:", error);
                    dispatch({ type: 'SET_ARTICLES', payload: [] }); // Clear articles on error
                }
            }, []);

            const handleSelectArticle = useCallback((article) => {
                if (!article.isRead) {
                    window.api.markArticleAsRead(article.id).catch(err => console.error("Failed to mark as read:", err));
                }
                dispatch({ type: 'SELECT_ARTICLE', payload: article });
            }, []);

            const handleAddFeed = useCallback(async (url) => {
                const newFeed = await window.api.addFeed(url);
                dispatch({ type: 'ADD_FEED', payload: newFeed });
            }, []);

            const handleDeleteFeed = useCallback(async (id) => {
                await window.api.deleteFeed(id);
                dispatch({ type: 'DELETE_FEED', payload: id });
            }, []);

            const handleUpdateFeedName = useCallback(async (feedId, displayName) => {
                await window.api.updateFeedDisplayName(feedId, displayName);
                dispatch({ type: 'UPDATE_FEED_DISPLAY_NAME', payload: { feedId, displayName } });
            }, []);

            const handleRetrySummarization = useCallback(async (articleId) => {
                try {
                    await window.api.retrySummarization(articleId);
                } catch (error) {
                    console.error("Failed to retry summarization:", error);
                    alert("Failed to retry summarization. See console for details.");
                }
            }, []);

            const handleCreateFolder = useCallback(async (folderName) => {
                const newFolder = await window.api.createFolder(folderName);
                dispatch({ type: 'ADD_FOLDER', payload: newFolder });
            }, []);

            const handleDeleteFolder = useCallback(async (folderId) => {
                await window.api.deleteFolder(folderId);
                dispatch({ type: 'DELETE_FOLDER', payload: folderId });
            }, []);

            const handleMoveFeedToFolder = useCallback(async (feedId, folderId) => {
                await window.api.moveFeedToFolder(feedId, folderId);
                dispatch({ type: 'MOVE_FEED_TO_FOLDER', payload: { feedId, folderId } });
            }, []);

            const handleToggleFolder = useCallback((folderId) => {
                dispatch({ type: 'TOGGLE_FOLDER', payload: folderId });
            }, []);

            // Drag and Drop handlers
            const handleDragStart = useCallback((e, item) => {
                e.stopPropagation();
                dispatch({ type: 'SET_DRAGGED_ITEM', payload: item });
                e.dataTransfer.effectAllowed = 'move';
            }, []);

            const handleDragOver = useCallback((e, item) => {
                e.preventDefault();
                e.stopPropagation();
                e.dataTransfer.dropEffect = 'move';
                dispatch({ type: 'SET_DRAG_OVER_ITEM', payload: item });
            }, []);

            const handleDragEnd = useCallback(() => {
                dispatch({ type: 'SET_DRAGGED_ITEM', payload: null });
                dispatch({ type: 'SET_DRAG_OVER_ITEM', payload: null });
            }, []);

            const handleDrop = useCallback(async (e, dropTarget) => {
                e.preventDefault();
                e.stopPropagation();
                
                if (!draggedItem) return;

                try {
                    // Handle feed drops
                    if (draggedItem.type === 'feed') {
                        // Dropping feed into folder
                        if (dropTarget.type === 'folder-content') {
                            const targetFolderId = dropTarget.id;
                            if (draggedItem.data.folderId !== targetFolderId) {
                                await window.api.moveFeedToFolder(draggedItem.id, targetFolderId);
                                dispatch({ type: 'MOVE_FEED_TO_FOLDER', payload: { feedId: draggedItem.id, folderId: targetFolderId } });
                            }
                        }
                        // Dropping feed into uncategorized
                        else if (dropTarget.type === 'uncategorized') {
                            if (draggedItem.data.folderId !== null) {
                                await window.api.moveFeedToFolder(draggedItem.id, null);
                                dispatch({ type: 'MOVE_FEED_TO_FOLDER', payload: { feedId: draggedItem.id, folderId: null } });
                            }
                        }
                        // Reordering feeds within same context
                        else if (dropTarget.type === 'feed') {
                            const targetFolder = dropTarget.folderContext;
                            const sourceFolder = draggedItem.data.folderId;
                            
                            if (targetFolder === sourceFolder) {
                                // Calculate new index
                                const feedsInFolder = feeds.filter(f => f.folderId === targetFolder);
                                const targetIndex = feedsInFolder.findIndex(f => f.id === dropTarget.id);
                                
                                await window.api.reorderFeeds(draggedItem.id, targetIndex, targetFolder);
                                
                                // Refresh feeds to get updated order
                                const allFeeds = await window.api.getFeeds();
                                dispatch({ type: 'SET_FEEDS', payload: allFeeds });
                            } else {
                                // Moving to different folder
                                await window.api.moveFeedToFolder(draggedItem.id, targetFolder);
                                dispatch({ type: 'MOVE_FEED_TO_FOLDER', payload: { feedId: draggedItem.id, folderId: targetFolder } });
                            }
                        }
                    }
                    // Handle folder drops (reordering)
                    else if (draggedItem.type === 'folder' && dropTarget.type === 'folder') {
                        const targetIndex = folders.findIndex(f => f.id === dropTarget.id);
                        await window.api.reorderFolders(draggedItem.id, targetIndex);
                        
                        // Refresh folders to get updated order
                        const allFolders = await window.api.getFolders();
                        dispatch({ type: 'SET_FOLDERS', payload: allFolders });
                    }
                } catch (error) {
                    console.error('Drag and drop error:', error);
                }

                handleDragEnd();
            }, [draggedItem, feeds, folders]);

            // --- Effects ---
            useEffect(() => {
                Promise.all([
                    window.api.getFeeds(),
                    window.api.getFolders()
                ]).then(([allFeeds, allFolders]) => {
                    dispatch({ type: 'SET_FEEDS', payload: allFeeds });
                    dispatch({ type: 'SET_FOLDERS', payload: allFolders });
                }).catch(console.error);
            }, []);
            
            useEffect(() => {
                const cleanupArticles = window.api.onArticlesUpdated(({ feedId }) => {
                    if (selectedFeed?.id === feedId) {
                        handleSelectFeed(selectedFeed);
                    }
                });

                const cleanupStatus = window.api.onArticleStatusUpdated((payload) => {
                    dispatch({ type: 'UPDATE_ARTICLE_STATUS', payload });
                });

                return () => {
                    cleanupArticles();
                    cleanupStatus();
                };
            }, [selectedFeed, handleSelectFeed]);

            if (!window.api) {
                return (
                    <div className="h-screen w-screen flex items-center justify-center bg-gray-900 text-white p-8">
                        <div className="text-center bg-red-800 rounded-lg p-6 shadow-2xl max-w-2xl">
                            <h1 className="text-3xl font-bold mb-4"><i className="fas fa-exclamation-triangle mr-3"></i>Fatal Error</h1>
                            <p className="text-lg">The application's backend API (`window.api`) failed to load.</p>
                            <p className="mt-2 text-gray-300">This is a common setup issue. Please open the Developer Tools (usually under the "View" menu) and check the Console for errors. Ensure your `preload.js` script is correctly named and configured in your `main.js` file.</p>
                        </div>
                    </div>
                );
            }

            return (
                <>
                    <div className="h-screen w-screen grid grid-cols-1 md:grid-cols-12">
                        <div className="col-span-12 md:col-span-3 lg:col-span-2 overflow-hidden">
                           <FeedsPanel 
                                feeds={feeds}
                                folders={folders}
                                selectedFeed={selectedFeed}
                                expandedFolders={expandedFolders}
                                draggedItem={draggedItem}
                                dragOverItem={dragOverItem}
                                onSelectFeed={handleSelectFeed}
                                onShowSettings={() => dispatch({ type: 'SHOW_SETTINGS' })}
                                onToggleFolder={handleToggleFolder}
                                onDragStart={handleDragStart}
                                onDragOver={handleDragOver}
                                onDragEnd={handleDragEnd}
                                onDrop={handleDrop}
                            />
                        </div>
                        <div className="col-span-12 md:col-span-4 lg:col-span-3 overflow-hidden">
                           <ArticlesPanel 
                                articles={articles}
                                selectedArticle={selectedArticle}
                                onSelectArticle={handleSelectArticle}
                                isLoading={isLoadingArticles}
                            />
                        </div>
                        <div className="col-span-12 md:col-span-5 lg:col-span-7">
                           <ContentPanel 
                                article={selectedArticle} 
                                onRetrySummarization={handleRetrySummarization}
                           />
                        </div>
                    </div>
                    <SettingsModal 
                        feeds={feeds}
                        folders={folders}
                        isVisible={isSettingsVisible} 
                        onClose={() => dispatch({ type: 'HIDE_SETTINGS' })} 
                        onAddFeed={handleAddFeed}
                        onDeleteFeed={handleDeleteFeed}
                        onUpdateFeedName={handleUpdateFeedName}
                        onCreateFolder={handleCreateFolder}
                        onDeleteFolder={handleDeleteFolder}
                        onMoveFeedToFolder={handleMoveFeedToFolder}
                    />
                </>
            );
        }
        
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>